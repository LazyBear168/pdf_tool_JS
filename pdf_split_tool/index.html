<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PDF_TOOL ‚Äì Split PDF by Page Range</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { margin-bottom: 10px; }
    table { border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 8px 12px; border: 1px solid #ccc; }
    input[type="number"], input[type="text"] { width: 100px; }
    button { margin: 5px; padding: 6px 12px; }
    #output { margin-top: 20px; }
    .note {
      background: #f3f3f3;
      border-left: 5px solid #999;
      padding: 10px;
      margin-top: 20px;
      max-width: 700px;
    }
  </style>
  <!-- PDF-lib + JSZip CDN -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
  <h1>üìÑ PDF Split Tool (PDF_TOOL)</h1>

  <label>Select PDF: <input type="file" id="pdf-upload" accept="application/pdf"></label><br><br>

  <table id="range-table">
    <tr>
      <th>Start Page</th>
      <th>End Page</th>
      <th>File Name</th>
      <th>Action</th>
    </tr>
  </table>

  <button onclick="addRow()">+ Add Row</button>
  <button onclick="splitPDF()">üî™ Split PDF</button>
  <button onclick="exportTable()">üì§ Export Page Table</button>
  <button onclick="document.getElementById('import-file').click()">üì• Import Page Table</button>
  <input type="file" id="import-file" accept=".json" style="display:none" onchange="importTable(event)">

  <div id="output"></div>

  <!-- ‚úÖ Export Help Note -->
  <div class="note">
    <strong>‚úÖ Problem 1: ‚ÄúDidn‚Äôt let me choose location to download table‚Äù</strong><br><br>
    <strong>‚ùó Why This Happens:</strong><br>
    Browsers don‚Äôt allow JavaScript to open the system ‚ÄúSave As‚Äù dialog directly. Instead, the browser auto-downloads to your default Downloads folder unless the user has changed the setting.
    <br><br>
    <strong>‚úÖ Solution (Mac Chrome/Safari users):</strong><br>
    <ul>
      <li><strong>In Chrome:</strong><br>
      Go to <code>chrome://settings/downloads</code><br>
      Toggle ON: <strong>‚ÄúAsk where to save each file before downloading‚Äù</strong></li>
      <br>
      <li><strong>In Safari:</strong><br>
      Go to <strong>Safari > Settings > General</strong><br>
      Choose: <strong>‚ÄúAsk for each download‚Äù</strong> under File download location</li>
    </ul>
    ‚úÖ Once set, you‚Äôll be prompted every time you export the table.
  </div>

  <script>
    let pdfDoc;
    const splitFiles = [];

    document.getElementById('pdf-upload').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const buffer = await file.arrayBuffer();
      pdfDoc = await PDFLib.PDFDocument.load(buffer);
      alert(`PDF loaded with ${pdfDoc.getPageCount()} pages.`);
      splitFiles.length = 0;
      document.getElementById("output").innerHTML = "";
    });

    function addRow() {
      const table = document.getElementById("range-table");
      const row = table.insertRow();
      row.innerHTML = `
        <td><input type="number" min="1" required></td>
        <td><input type="number" min="1" required></td>
        <td><input type="text" placeholder="output.pdf" required></td>
        <td><button onclick="deleteRow(this)">‚ùå</button></td>
      `;
    }

    function deleteRow(btn) {
      const row = btn.parentNode.parentNode;
      row.remove();
    }

    async function splitPDF() {
      if (!pdfDoc) {
        alert("Please upload a PDF first.");
        return;
      }

      splitFiles.length = 0;
      document.getElementById("output").innerHTML = "";

      const table = document.getElementById("range-table");
      const rows = table.querySelectorAll("tr:not(:first-child)");
      const pageCount = pdfDoc.getPageCount();

      for (const row of rows) {
        const start = parseInt(row.cells[0].querySelector("input").value) - 1;
        const end = parseInt(row.cells[1].querySelector("input").value) - 1;
        let name = row.cells[2].querySelector("input").value.trim();
        if (!name.toLowerCase().endsWith(".pdf")) {
          name += ".pdf";
        }

        if (start < 0 || end >= pageCount || start > end) {
          alert(`Invalid range: ${start + 1} to ${end + 1}`);
          continue;
        }

        const newPdf = await PDFLib.PDFDocument.create();
        const copiedPages = await newPdf.copyPages(pdfDoc, Array.from({ length: end - start + 1 }, (_, i) => i + start));
        copiedPages.forEach(p => newPdf.addPage(p));

        const bytes = await newPdf.save();
        const blob = new Blob([bytes], { type: 'application/pdf' });
        splitFiles.push({ name, blob });

        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = name;
        link.textContent = `Download ${name}`;
        document.getElementById("output").appendChild(link);
        document.getElementById("output").appendChild(document.createElement("br"));
      }

      if (splitFiles.length > 0) {
        const zipBtn = document.createElement("button");
        zipBtn.textContent = "üì¶ Download All as ZIP";
        zipBtn.onclick = downloadAllAsZip;
        document.getElementById("output").appendChild(zipBtn);
      }
    }

    function exportTable() {
      const rows = document.querySelectorAll("#range-table tr:not(:first-child)");
      const data = [];

      for (const row of rows) {
        const start = row.cells[0].querySelector("input").value;
        const end = row.cells[1].querySelector("input").value;
        const name = row.cells[2].querySelector("input").value;
        data.push({ start, end, name });
      }

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = "page_table.json";
      link.target = '_blank';
      link.click();

      setTimeout(() => URL.revokeObjectURL(link.href), 1000);
    }

    function importTable(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const rows = JSON.parse(e.target.result);

        const table = document.getElementById("range-table");
        const oldRows = table.querySelectorAll("tr:not(:first-child)");
        oldRows.forEach(r => r.remove());

        rows.forEach(entry => {
          const row = table.insertRow();
          row.innerHTML = `
            <td><input type="number" min="1" value="${entry.start}" required></td>
            <td><input type="number" min="1" value="${entry.end}" required></td>
            <td><input type="text" value="${entry.name}" required></td>
            <td><button onclick="deleteRow(this)">‚ùå</button></td>
          `;
        });
      };
      reader.readAsText(file);
    }

    async function downloadAllAsZip() {
      const zip = new JSZip();
      splitFiles.forEach(file => {
        zip.file(file.name, file.blob);
      });

      const content = await zip.generateAsync({ type: "blob" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(content);
      link.download = "all_splits.zip";
      link.click();

      setTimeout(() => URL.revokeObjectURL(link.href), 1000);
    }
  </script>
</body>
</html>
