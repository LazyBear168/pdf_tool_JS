<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PDF to EPUB Converter</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 700px; margin: auto; }
    h1 { font-size: 24px; }
    input, button { margin: 10px 0; padding: 8px 12px; }
  </style>
</head>
<body>

<h1>ðŸ“š PDF to EPUB Converter</h1>
<label>Select PDF File:</label><br/>
<input type="file" id="pdfFile" accept="application/pdf" /><br/>
<label>Select TOC JSON File (optional):</label><br/>
<input type="file" id="tocFile" accept="application/json" /><br/>
<button onclick="convertPDF()">Convert to EPUB</button>

<script>
function cleanText(rawText) {
  return rawText
    .replace(/[\u0000-\u001F\u007F]/g, '') // Remove invalid control characters
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

async function convertPDF() {
  const pdfInput = document.getElementById('pdfFile');
  const tocInput = document.getElementById('tocFile');

  if (!pdfInput.files.length) {
    alert("Please select a PDF file.");
    return;
  }

  const pdfData = await pdfInput.files[0].arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;

  let toc = [];
  if (tocInput.files.length) {
    const tocText = await tocInput.files[0].text();
    toc = JSON.parse(tocText);
  } else {
    toc = [{ start: 1, end: pdf.numPages, name: "Chapter 1" }];
  }

  let manifestItems = '';
  let spineItems = '';
  let navPoints = '';
  const chapterFiles = [];

  for (let i = 0; i < toc.length; i++) {
    const { start, end, name } = toc[i];
    let chapterText = '';

    for (let p = parseInt(start); p <= parseInt(end); p++) {
      if (p > pdf.numPages) break;
      const page = await pdf.getPage(p);
      const textContent = await page.getTextContent();
      const pageText = textContent.items.map(item => item.str).join(' ');
      chapterText += `<p>${cleanText(pageText)}</p>\n`;
    }

    const filename = `chapter${i + 1}.xhtml`;
    const chapterHTML = `<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head><title>${name}</title></head>
  <body><h1>${name}</h1>${chapterText}</body>
</html>`;

    chapterFiles.push({ filename, content: chapterHTML });
    manifestItems += `<item id="chap${i + 1}" href="${filename}" media-type="application/xhtml+xml"/>\n`;
    spineItems += `<itemref idref="chap${i + 1}"/>\n`;
    navPoints += `<navPoint id="navPoint-${i + 1}" playOrder="${i + 1}">
      <navLabel><text>${name}</text></navLabel>
      <content src="${filename}"/>
    </navPoint>\n`;
  }

  const contentOPF = `<?xml version="1.0" encoding="UTF-8"?>
<package xmlns="http://www.idpf.org/2007/opf" version="2.0" unique-identifier="bookid">
  <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">
    <dc:title>My Book</dc:title>
    <dc:creator>Author</dc:creator>
    <dc:language>en</dc:language>
    <dc:identifier id="bookid">urn:uuid:12345</dc:identifier>
  </metadata>
  <manifest>
    ${manifestItems}
    <item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>
  </manifest>
  <spine toc="ncx">
    ${spineItems}
  </spine>
</package>`;

  const tocNCX = `<?xml version="1.0" encoding="UTF-8"?>
<ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1">
  <head><meta name="dtb:uid" content="urn:uuid:12345"/></head>
  <docTitle><text>My Book</text></docTitle>
  <navMap>${navPoints}</navMap>
</ncx>`;

  const containerXML = `<?xml version="1.0" encoding="UTF-8"?>
<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">
  <rootfiles>
    <rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/>
  </rootfiles>
</container>`;

  const zip = new JSZip();
  zip.file("mimetype", "application/epub+zip");

  const metaInf = zip.folder("META-INF");
  metaInf.file("container.xml", containerXML);

  const oebps = zip.folder("OEBPS");
  chapterFiles.forEach(({ filename, content }) => {
    oebps.file(filename, content);
  });
  oebps.file("content.opf", contentOPF);
  oebps.file("toc.ncx", tocNCX);

  const blob = await zip.generateAsync({
    type: "blob",
    mimeType: "application/epub+zip",
    compression: "STORE",
    streamFiles: true
  });

  saveAs(blob, "my-book.epub");
}
</script>

</body>
</html>
