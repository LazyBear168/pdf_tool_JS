<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PDF TOC â†’ Page Table Converter</title>
  <style>
    body { font-family: Arial; padding: 20px; max-width: 800px; }
    textarea, pre { width: 100%; height: 250px; }
    input[type="number"] { width: 100px; }
    button { margin: 10px 5px 0 0; padding: 6px 12px; }
  </style>
</head>
<body>
  <h2>ðŸ“˜ TOC Converter with Page Range</h2>

  <p>1. Upload your <code>toc.txt</code> file (exported from <code>pdftk</code>)</p>
  <input type="file" id="fileInput" accept=".txt"><br><br>

  <p>2. Enter total number of pages in your PDF:</p>
  <input type="number" id="totalPages" placeholder="e.g. 3000"><br><br>

  <button onclick="convert()">Convert & Preview</button>
  <button onclick="downloadJSON()">ðŸ“¥ Download JSON</button>

  <h3>ðŸ”Ž JSON Preview</h3>
  <pre id="preview">{}</pre>

  <script>
    let resultJson = [];

    function convert() {
      const file = document.getElementById("fileInput").files[0];
      const totalPages = parseInt(document.getElementById("totalPages").value);

      if (!file) return alert("Please upload toc.txt");
      if (!totalPages || totalPages <= 0) return alert("Please enter a valid total page number");

      const reader = new FileReader();
      reader.onload = function (e) {
        const lines = e.target.result.split("\n");
        const rawEntries = [];
        let current = {};

        for (let line of lines) {
          line = line.trim();
          if (line.startsWith("BookmarkTitle:")) {
            current.name = line.replace("BookmarkTitle:", "").trim();
          } else if (line.startsWith("BookmarkPageNumber:")) {
            current.start = parseInt(line.replace("BookmarkPageNumber:", "").trim());
            rawEntries.push(current);
            current = {};
          }
        }

        // Build final result with start and end
        resultJson = rawEntries.map((entry, index) => {
          const start = entry.start;
          const end = (index < rawEntries.length - 1)
            ? rawEntries[index + 1].start - 1
            : totalPages; // last one goes to end of PDF

          return {
            start: String(start),
            end: String(end),
            name: entry.name
          };
        });

        document.getElementById("preview").textContent = JSON.stringify(resultJson, null, 2);
      };

      reader.readAsText(file);
    }

    function downloadJSON() {
      if (resultJson.length === 0) return alert("Please convert first.");
      const blob = new Blob([JSON.stringify(resultJson, null, 2)], { type: "application/json" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "toc_page_table.json";
      link.click();
      URL.revokeObjectURL(link.href);
    }
  </script>
</body>
</html>
